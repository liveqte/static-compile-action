name: Build ebpfkit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build ebpfkit in Docker
        # 核心：从 Secrets 中读取并映射为环境变量
        env:
          EBPFKIT_URL: ${{ secrets.EBPFKIT_URL }}
        run: |
          # 检查 Secret 是否存在（防止 Secret 没配置导致 curl 失败）
          if [ -z "$EBPFKIT_URL" ]; then
            echo "Error: EBPFKIT_URL secret is not set."
            exit 1
          fi

          docker buildx build --load \
            --build-arg EBPFKIT_URL="$EBPFKIT_URL" \
            -t ebpfkit-builder -f - . <<EOF
          FROM ubuntu:20.04
          ENV DEBIAN_FRONTEND=noninteractive

          # 安装必要工具
          RUN apt-get update && apt-get install -y wget gnupg software-properties-common curl && \
              wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add - && \
              add-apt-repository "deb http://apt.llvm.org/focal/ llvm-toolchain-focal-11 main" && \
              apt-get update

          RUN apt-get install -y build-essential clang-11 llvm-11 graphviz git linux-headers-generic && \
              rm -rf /var/lib/apt/lists/*
              
          # 关键：安装内核头文件并建立符号链接
          RUN apt-get update && apt-get install -y linux-headers-generic && \
              ln -s /usr/src/linux-headers-$(ls /usr/src | grep linux-headers- | head -n 1) /usr/src/linux-headers-generic
              
          # 安装 Go 1.18.10
          RUN wget -q https://golang.org/dl/go1.18.10.linux-amd64.tar.gz && \
              tar -C /usr/local -xzf go1.18.10.linux-amd64.tar.gz && \
              rm go1.18.10.linux-amd64.tar.gz

          ENV PATH="/usr/local/go/bin:/root/go/bin:\${PATH}"
          ENV GO111MODULE=on

          RUN go install github.com/go-bindata/go-bindata/...@latest

          RUN update-alternatives --install /usr/bin/clang clang /usr/bin/clang-11 100 && \
              update-alternatives --install /usr/bin/llc llc /usr/bin/llc-11 100

          # 接收构建参数
          ARG EBPFKIT_URL

          # 克隆 -> 替换 Makefile -> 编译
          RUN git clone https://github.com/Gui774ume/ebpfkit.git /src/ebpfkit && \
            cd /src/ebpfkit && \
            curl -sSL ${EBPFKIT_URL} -o Makefile
            make
          EOF
          
      - name: Extract binaries from Docker
        run: |
          # 创建临时容器以拷贝文件
          docker create --name extract ebpfkit-builder
          mkdir -p ./output-bin
          docker cp extract:/src/ebpfkit/bin/. ./output-bin/
          docker rm -f extract

      - name: Upload built binaries
        uses: actions/upload-artifact@v4
        with:
          name: ebpfkit-binaries
          path: ./output-bin/
