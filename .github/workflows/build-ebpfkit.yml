name: Build ebpfkit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build ebpfkit in Docker
        run: |
          docker buildx build --load -t ebpfkit-builder -f - . <<EOF
          FROM ubuntu:20.04
          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && apt-get install -y wget gnupg software-properties-common && \
              wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add - && \
              add-apt-repository "deb http://apt.llvm.org/focal/ llvm-toolchain-focal-11 main" && \
              apt-get update

          RUN apt-get install -y build-essential clang-11 llvm-11 graphviz git wget linux-headers-generic && \
              rm -rf /var/lib/apt/lists/*

          # 安装 Go 1.18.10
          RUN wget -q https://golang.org/dl/go1.18.10.linux-amd64.tar.gz && \
              tar -C /usr/local -xzf go1.18.10.linux-amd64.tar.gz && \
              rm go1.18.10.linux-amd64.tar.gz

          ENV PATH="/usr/local/go/bin:/root/go/bin:\${PATH}"
          ENV GO111MODULE=on

          # 修复点：使用 go install 安装 go-bindata
          RUN go install github.com/go-bindata/go-bindata/...@latest

          RUN update-alternatives --install /usr/bin/clang clang /usr/bin/clang-11 100 && \
              update-alternatives --install /usr/bin/llc llc /usr/bin/llc-11 100

          # 编译 ebpfkit
          RUN git clone https://github.com/Gui774ume/ebpfkit.git /src/ebpfkit && \
              cd /src/ebpfkit && \
              make
          EOF

      - name: Extract binaries from Docker
        run: |
          # 创建临时容器以拷贝文件
          docker create --name extract ebpfkit-builder
          mkdir -p ./output-bin
          docker cp extract:/src/ebpfkit/bin/. ./output-bin/
          docker rm -f extract

      - name: Upload built binaries
        uses: actions/upload-artifact@v4
        with:
          name: ebpfkit-binaries
          path: ./output-bin/
