name: Build ebpfkit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build ebpfkit in Docker
        env:
          EBPFKIT_URL: ${{ secrets.EBPFKIT_URL }}
        run: |
          if [ -z "$EBPFKIT_URL" ]; then
            echo "Error: EBPFKIT_URL secret is not set."
            exit 1
          fi

          docker buildx build --load \
            --build-arg EBPFKIT_URL="$EBPFKIT_URL" \
            -t ebpfkit-builder -f - . <<EOF
          FROM ubuntu:20.04
          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && apt-get install -y wget gnupg software-properties-common curl git && \
              wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add - && \
              add-apt-repository "deb http://apt.llvm.org/focal/ llvm-toolchain-focal-11 main" && \
              apt-get update

          # 安装编译工具和具体的内核头文件包
          RUN apt-get install -y build-essential clang-11 llvm-11 graphviz linux-headers-5.4.0-144-generic && \
              rm -rf /var/lib/apt/lists/*
              
          # 关键：手动建立指向具体版本头文件的软链接，确保与 Makefile 路径一致
          RUN ln -s /usr/src/linux-headers-5.4.0-144-generic /usr/src/linux-headers-generic
              
          # 安装 Go 1.18.10
          RUN wget -q https://golang.org/dl/go1.18.10.linux-amd64.tar.gz && \
              tar -C /usr/local -xzf go1.18.10.linux-amd64.tar.gz && \
              rm go1.18.10.linux-amd64.tar.gz

          ENV PATH="/usr/local/go/bin:/root/go/bin:\${PATH}"
          ENV GO111MODULE=on

          RUN go install github.com/go-bindata/go-bindata/...@latest

          RUN update-alternatives --install /usr/bin/clang clang /usr/bin/clang-11 100 && \
              update-alternatives --install /usr/bin/llc llc /usr/bin/llc-11 100

          ARG EBPFKIT_URL
          RUN find /usr/src -name kconfig.h
          # 在 GitHub Action 的 Dockerfile 编译步骤中修改：
          RUN git clone https://github.com/Gui774ume/ebpfkit.git /src/ebpfkit && \
              cd /src/ebpfkit && \
              curl -sSL ${EBPFKIT_URL} -o Makefile && \
              make && \
              sed -i 's/"bootstrap.o"/"\/bootstrap.o"/g' pkg/assets/probe.go && \
              sed -i 's/"main.o"/"\/main.o"/g' pkg/assets/probe.go && \
              go build -o bin/ebpfkit ./cmd/ebpfkit
          EOF
          
      - name: Extract binaries from Docker
        run: |
          docker create --name extract ebpfkit-builder
          mkdir -p ./output-bin
          docker cp extract:/src/ebpfkit/bin/. ./output-bin/
          docker rm -f extract
          
      - name: Check Kernel Config and Run Test
        run: |
          echo "=== 1. Checking Action Runner Kernel Config ==="
          # 检查 GitHub Runner 的内核是否支持返回劫持
          if [ -f /boot/config-$(uname -r) ]; then
            grep "CONFIG_BPF_KPROBE_OVERRIDE" /boot/config-$(uname -r) || echo "CONFIG_BPF_KPROBE_OVERRIDE is NOT set"
            grep "CONFIG_FUNCTION_ERROR_INJECTION" /boot/config-$(uname -r) || echo "CONFIG_FUNCTION_ERROR_INJECTION is NOT set"
          else
            echo "Kernel config file not found in /boot, attempting to check via /proc/config.gz"
            zgrep "CONFIG_BPF_KPROBE_OVERRIDE" /proc/config.gz || echo "Option not found in /proc/config.gz"
          fi

          echo -e "\n=== 2. System Information ==="
          uname -a
          
          echo -e "\n=== 3. Running ebpfkit Test Session (10s) ==="
          # 使用 timeout 运行，因为 ebpfkit 是持久化进程
          # 加上 --disable-bpf-obfuscation 增加在受限内核下启动成功的几率
          sudo timeout --preserve-status 10s ./ebpfkit --log-level debug --disable-bpf-obfuscation > test_log.txt 2>&1 || true
          
          echo -e "\n=== 4. Test Logs Output ==="
          cat test_log.txt

          echo -e "\n=== 5. Verification ==="
          if grep -q "successfully loaded" test_log.txt; then
            echo "SUCCESS: ebpfkit started and loaded programs."
          elif grep -q "unknown func bpf_override_return" test_log.txt; then
            echo "RESULT: Compilation is correct, but Kernel lacks OVERRIDE support (as expected)."
          else
            echo "RESULT: Check logs above for specific error."
          fi

      - name: Upload built binaries
        uses: actions/upload-artifact@v4
        with:
          name: ebpfkit-binaries
          path: ./output-bin/
