name: Build ebpfkit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04  # 能正常排队，2025 年稳定支持

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ebpfkit using Ubuntu 20.04 environment
        run: |
          docker buildx build --load --platform linux/amd64 -t ebpfkit-builder -f - . <<EOF
          # 严格复现原作者 Ubuntu Focal 环境
          FROM ubuntu:20.04

          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && apt-get install -y \
              build-essential \
              clang-11 \
              llvm-11 \
              graphviz \
              git \
              wget \
              software-properties-common \
              && rm -rf /var/lib/apt/lists/*

          # 安装通用内核头文件（容器内不需要精确匹配宿主机内核）
          RUN apt-get update && apt-get install -y linux-headers-generic

          # 安装 Go 1.13.15
          RUN wget -q https://golang.org/dl/go1.13.15.linux-amd64.tar.gz && \
              tar -C /usr/local -xzf go1.13.15.linux-amd64.tar.gz && \
              rm go1.13.15.linux-amd64.tar.gz

          ENV PATH="/usr/local/go/bin:\${PATH}"
          ENV GO111MODULE=on

          # 安装 go-bindata
          RUN go get github.com/shuLhan/go-bindata/...@v4.0.0 && \
              go install github.com/shuLhan/go-bindata/cmd/go-bindata@latest

          WORKDIR /src/ebpfkit

          COPY . .

          RUN make

          RUN ls -la bin/ && file bin/ebpfkit bin/ebpfkit-client

          EOF

      - name: Upload built binaries
        uses: actions/upload-artifact@v4
        with:
          name: ebpfkit-binaries-ubuntu20.04
          path: |
            bin/ebpfkit
            bin/ebpfkit-client
            bin/webapp
            bin/pause
