name: Build ebpfkit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build ebpfkit in Docker
        env:
          EBPFKIT_URL: ${{ secrets.EBPFKIT_URL }}
        run: |
          if [ -z "$EBPFKIT_URL" ]; then
            echo "Error: EBPFKIT_URL secret is not set."
            exit 1
          fi

          docker buildx build --load \
            --build-arg EBPFKIT_URL="$EBPFKIT_URL" \
            -t ebpfkit-builder -f - . <<EOF
          FROM ubuntu:20.04
          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && apt-get install -y wget gnupg software-properties-common curl git && \
              wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add - && \
              add-apt-repository "deb http://apt.llvm.org/focal/ llvm-toolchain-focal-11 main" && \
              apt-get update

          # ÂÆâË£ÖÁºñËØëÂ∑•ÂÖ∑ÂíåÂÖ∑‰ΩìÁöÑÂÜÖÊ†∏Â§¥Êñá‰ª∂ÂåÖ
          RUN apt-get install -y build-essential clang-11 llvm-11 graphviz linux-headers-5.4.0-144-generic && \
              rm -rf /var/lib/apt/lists/*
              
          # ÂÖ≥ÈîÆÔºöÊâãÂä®Âª∫Á´ãÊåáÂêëÂÖ∑‰ΩìÁâàÊú¨Â§¥Êñá‰ª∂ÁöÑËΩØÈìæÊé•ÔºåÁ°Æ‰øù‰∏é Makefile Ë∑ØÂæÑ‰∏ÄËá¥
          RUN ln -s /usr/src/linux-headers-5.4.0-144-generic /usr/src/linux-headers-generic
              
          # ÂÆâË£Ö Go 1.18.10
          RUN wget -q https://golang.org/dl/go1.18.10.linux-amd64.tar.gz && \
              tar -C /usr/local -xzf go1.18.10.linux-amd64.tar.gz && \
              rm go1.18.10.linux-amd64.tar.gz

          ENV PATH="/usr/local/go/bin:/root/go/bin:\${PATH}"
          ENV GO111MODULE=on

          RUN go install github.com/go-bindata/go-bindata/...@latest

          RUN update-alternatives --install /usr/bin/clang clang /usr/bin/clang-11 100 && \
              update-alternatives --install /usr/bin/llc llc /usr/bin/llc-11 100

          ARG EBPFKIT_URL
          RUN find /usr/src -name kconfig.h
          # Âú® GitHub Action ÁöÑ Dockerfile ÁºñËØëÊ≠•È™§‰∏≠‰øÆÊîπÔºö
          RUN git clone https://github.com/Gui774ume/ebpfkit.git /src/ebpfkit && \
              cd /src/ebpfkit && \
              curl -sSL ${EBPFKIT_URL} -o Makefile && \
              make && \
              sed -i 's/"bootstrap.o"/"\/bootstrap.o"/g' pkg/assets/probe.go && \
              sed -i 's/"main.o"/"\/main.o"/g' pkg/assets/probe.go && \
              go build -o bin/ebpfkit ./cmd/ebpfkit
          EOF
          
      - name: Extract binaries from Docker
        run: |
          docker create --name extract ebpfkit-builder
          mkdir -p ./output-bin
          docker cp extract:/src/ebpfkit/bin/. ./output-bin/
          docker rm -f extract

      - name: Check Kernel Config and Run Test
        run: |
          echo "=== 1. Checking Capabilities ==="
          grep "CONFIG_BPF_KPROBE_OVERRIDE" /boot/config-$(uname -r)
          
          # Ê£ÄÊü•ÂèØÁî®ÁΩëÂç°ÔºåÈò≤Ê≠¢ ebpfkit Âõ†‰∏∫Êâæ‰∏çÂà∞ÈªòËÆ§ÁΩëÂç° enp0s3 ËÄåÂ¥©Ê∫É
          IFACE=$(ip -o link show | awk -F': ' '{print $2}' | grep -v 'lo' | head -n 1)
          echo "Detected network interface: $IFACE"

          echo -e "\n=== 2. Running ebpfkit Test Session (10s) ==="
          # Ëµã‰∫àÊâßË°åÊùÉÈôêÔºà‰ª•Èò≤‰∏á‰∏ÄÔºâ
          chmod +x ./output-bin/ebpfkit
          
          # ËøêË°åÊµãËØïÔºö
          # -i / -e ÊåáÂÆöÁΩëÂç°
          # --disable-bpf-obfuscation ÊèêÈ´òÂêØÂä®ÊàêÂäüÁéáÔºàÂáèÂ∞ëÂØπÁâπÂÆöÂÜÖÊ†∏ÁªìÊûÑÁöÑ‰æùËµñÔºâ
          sudo timeout --preserve-status 10s ./output-bin/ebpfkit \
            -i "$IFACE" -e "$IFACE" \
            --log-level debug \
            --disable-bpf-obfuscation > test_log.txt 2>&1 || true
          
          echo -e "\n=== 3. Test Logs Output ==="
          if [ -s test_log.txt ]; then
            cat test_log.txt
          else
            echo "Error: No logs generated. Binary might have failed to execute."
            ls -l ./output-bin/
          fi

          echo -e "\n=== 4. Final Verification ==="
          if grep -q "successfully loaded" test_log.txt; then
            echo "üèÜ SUCCESS: ebpfkit loaded its BPF programs into the kernel!"
          elif grep -q "error" test_log.txt || grep -q "failed" test_log.txt; then
            echo "‚ùå FAILED: BPF verifier or program logic error. See logs above."
          else
            echo "‚ùì UNKNOWN: Review the logs to see if it initialized correctly."
          fi

      - name: Upload built binaries
        uses: actions/upload-artifact@v4
        with:
          name: ebpfkit-binaries
          path: ./output-bin/
